@page "/login"
@using MauiBlazorWeb.Shared.Services
@inject NavigationManager Navigation
@inject MauiAuthenticationStateProvider AuthStateProvider
@inject IAuthService Auth
<h3>Login to Access Application</h3>

<EditForm Model="LoginModel" OnValidSubmit="LoginUser" FormName="login">
    <DataAnnotationsValidator/>
    <ValidationSummary/>
    <div class="alert alert-danger" hidden="@loginFailureHidden">
        @AuthStateProvider.LoginFailureMessage
        @if (diagnosticInfo != null)
        {
            <pre style="font-size: 10px; max-height: 100px; overflow: auto;">@diagnosticInfo</pre>
        }
    </div>
    <div class="form-group">
        <label>Email</label>
        <InputText id="email" @bind-Value="LoginModel.Email" class="form-control"/>
    </div>
    <div class="form-group">
        <label>Password</label>
        <InputText id="password" type="password" @bind-Value="LoginModel.Password" class="form-control"/>
    </div>
    <div class="form-group my-2">
        <label>
            <InputCheckbox @bind-Value="RememberMe"/>
            Remember me
        </label>
    </div>
    <div class="form-group mt-1">
        <button type="submit" class="btn btn-primary w-100">Login Now</button>
    </div>
</EditForm>

<button @onclick="RunDiagnostics" class="btn btn-outline-secondary mt-2">Run Network Diagnostics</button>

@code {
    private LoginRequest LoginModel { get; } = new();
    private bool loginFailureHidden = true;
    private string? diagnosticInfo;
    private bool RememberMe { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        var isAuth = await Auth.IsAuthenticatedAsync(); // now checks expiry too
        if (isAuth)
        {
            Navigation.NavigateTo("/");
            return;
        }

        if (AuthStateProvider.LoginStatus == LoginStatus.Failed)
        {
            loginFailureHidden = false;
        }

        // Check if a user is already logged in
        if (await AuthStateProvider.HasValidSessionAsync())
        {
            Navigation.NavigateTo(""); // Redirect to home if already logged in
            return;
        }

        // Auto-populate saved email if available
        var savedEmail = await AuthStateProvider.GetSavedEmailAsync();
        if (!string.IsNullOrEmpty(savedEmail))
        {
            LoginModel.Email = savedEmail;
        }
    }

    private async Task LoginUser()
    {
        await AuthStateProvider.LogInAsync(LoginModel);

        if (AuthStateProvider.LoginStatus != LoginStatus.Success)
        {
            loginFailureHidden = false;
            // Run diagnostics automatically on failure
            await RunDiagnostics();
            return;
        }

        Navigation.NavigateTo(""); //Root URL
    }

    private async Task RunDiagnostics()
    {
        diagnosticInfo = await NetworkDiagnostics.RunNetworkDiagnosticsAsync();
        StateHasChanged();
    }

}